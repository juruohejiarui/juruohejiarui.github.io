<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>XHCI</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="前言">前言</h1>
<p>本文参考了 <a href="https://wiki.osdev.org/XHCI">XHCI on OS Dev</a> 以及 《USB: The Universal Series Bus》。代码存储于 <code>github.com/juruohejiarui/VCPP-2.git</code> 中的 <code>VOS/kernel/hardware/USB</code> .</p>
<p>需要先简单了解 PCIe 的数据结构和枚举、检测 UEFI 提供的 PCIe 信息的方法。</p>
<h1 id="数据结构和注释">数据结构和注释</h1>
<h2 id="pcie">PCIe</h2>
<p>从 UEFI 提供的 <code>MCFG</code> 表中，可以读出一个 PCIe 数据表头的结构，我们称之为 <code>PCIeConfig</code>，对于 XHCI 设备，其结构一般如下：</p>
<table>
<colgroup>
<col style="width: 17%" />
<col style="width: 28%" />
<col style="width: 28%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Offset</th>
<th style="text-align: center;">Size(Byte)</th>
<th style="text-align: center;">Name</th>
<th style="text-align: center;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0x0</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></td>
<td style="text-align: center;">Vendor ID</td>
<td style="text-align: center;">制造商 ID</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x2</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></td>
<td style="text-align: center;">Device ID</td>
<td style="text-align: center;">制造商申请的设备特定的 ID</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x4</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></td>
<td style="text-align: center;">Command</td>
<td style="text-align: center;">用于操作该PCIe设备的寄存器</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x6</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></td>
<td style="text-align: center;">Status</td>
<td style="text-align: center;">该设备的状态</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x8</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Revision ID</td>
<td style="text-align: center;">我也不懂，应该不太重要，可以忽略</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x9</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Prog IF</td>
<td style="text-align: center;">Program Interface Byte, 只读，用于寄存器级别下指定该设备的类别</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0xa</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Subclass</td>
<td style="text-align: center;">子类 ID</td>
</tr>
<tr class="even">
<td style="text-align: center;">0xb</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Class Id</td>
<td style="text-align: center;">类 ID</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0xc</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Cache Line Size</td>
<td style="text-align: center;">我也不懂，应该不太重要，可以忽略</td>
</tr>
<tr class="even">
<td style="text-align: center;">0xd</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Latency Timer</td>
<td style="text-align: center;">用于PCI，PCIe不支持，固定为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math></td>
</tr>
<tr class="odd">
<td style="text-align: center;">0xe</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Header Type</td>
<td style="text-align: center;">指示该表头剩余内容的结构</td>
</tr>
<tr class="even">
<td style="text-align: center;">0xf</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">BIST</td>
<td style="text-align: center;">Built-in self test, 设备的内建自检状态和控制寄存器</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x10</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Bar0</td>
<td style="text-align: center;">Base Address 0</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x14</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Bar1</td>
<td style="text-align: center;">Base Address <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x18</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Bar2</td>
<td style="text-align: center;">Base Address <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></td>
</tr>
<tr class="even">
<td style="text-align: center;">0x1c</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Bar3</td>
<td style="text-align: center;">Base Address 3</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x20</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Bar4</td>
<td style="text-align: center;">Base Address <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
</tr>
<tr class="even">
<td style="text-align: center;">0x24</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Bar5</td>
<td style="text-align: center;">Base Address 5</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x28</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Cardbus CIS Pointer</td>
<td style="text-align: center;">指向 Cardbus 结构的指针，该值被 PCI 和 Cardbus 共享（机翻）</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x2c</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></td>
<td style="text-align: center;">Subsystem Vendor ID</td>
<td style="text-align: center;">子系统的Vendor ID, 不重要</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x2e</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></td>
<td style="text-align: center;">subsystem ID</td>
<td style="text-align: center;">子系统ID，不重要</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x30</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Expansion ROM base address</td>
<td style="text-align: center;">不懂，应该不太重要</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x34</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Capabilities Pointer</td>
<td style="text-align: center;">使能寄存器的偏移量</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x35</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>7</mn><annotation encoding="application/x-tex">7</annotation></semantics></math></td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: center;">保留位置，不能读写</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x3c</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Interrupt Line</td>
<td style="text-align: center;">用于指定该设备连接到 PIC (不是I/O APIC) 的 (IRQ0,IRQ1…IRQ15) 哪个（些）引脚, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟶𝚡𝚏𝚏</mtext><annotation encoding="application/x-tex">\texttt{0xff}</annotation></semantics></math> 则表示无连接</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x3d</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Interrupt PIN</td>
<td style="text-align: center;">用于指定该设备使用哪个中断引脚，<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="monospace">𝟶𝚡𝟶</mtext><mo>→</mo><mtext mathvariant="normal">does not use</mtext><mo>,</mo><mtext mathvariant="monospace">𝟶𝚡𝟷</mtext><mo>→</mo><mtext mathvariant="monospace">𝙸𝙽𝚃𝙰</mtext><mo>,</mo><mtext mathvariant="monospace">𝟶𝚡𝟸</mtext><mo>→</mo><mtext mathvariant="monospace">𝙸𝙽𝚃𝙱</mtext></mrow><annotation encoding="application/x-tex">\texttt{0x0}\rightarrow \text{does not use},\texttt{0x1}\rightarrow \texttt{INTA}, \texttt{0x2}\rightarrow \texttt{INTB}</annotation></semantics></math>, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="monospace">𝟶𝚡𝟹</mtext><mo>→</mo><mtext mathvariant="monospace">𝙸𝙽𝚃𝙲</mtext></mrow><annotation encoding="application/x-tex">\texttt{0x3}\rightarrow \texttt{INTC}</annotation></semantics></math>, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="monospace">𝟶𝚡𝟺</mtext><mo>→</mo><mtext mathvariant="monospace">𝙸𝙽𝚃𝙳</mtext></mrow><annotation encoding="application/x-tex">\texttt{0x4}\rightarrow \texttt{INTD}</annotation></semantics></math></td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x3e</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Min Grant</td>
<td style="text-align: center;">用于 PCI ，PCIe 下不可用，固定为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math></td>
</tr>
<tr class="even">
<td style="text-align: center;">0x3f</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Max Latency</td>
<td style="text-align: center;">用于 PCI ，PCIe 下不可用，固定为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math></td>
</tr>
</tbody>
</table>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Class Id, subClass, Prog IF</mtext><annotation encoding="application/x-tex">\text{Class Id, subClass, Prog IF}</annotation></semantics></math> 三者共同确认一个设备的类别，网上有对照表，这里就不粘出来了。对于 XHCI 设备，<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Class Id</mtext><mo>=</mo><mtext mathvariant="monospace">𝟶𝚡𝙲</mtext><mo>,</mo><mtext mathvariant="normal">Subclass</mtext><mo>=</mo><mtext mathvariant="monospace">𝟶𝚡𝟹</mtext><mo>,</mo><mtext mathvariant="normal">Prog IF</mtext><mo>=</mo><mtext mathvariant="monospace">𝟶𝚡𝟹𝟶</mtext></mrow><annotation encoding="application/x-tex">\text{Class Id}=\texttt{0xC}, \text{Subclass}=\texttt{0x3}, \text{Prog IF}=\texttt{0x30}</annotation></semantics></math></p>
<h3 id="header-type-结构">Header Type 结构</h3>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Bit 7</th>
<th style="text-align: center;">Bit 0 : 6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">该设备是(1)/否(0)为多功能(multi-function)设备</td>
<td style="text-align: center;">表头剩余结构的类型</td>
</tr>
</tbody>
</table>
<p>对于 Bit <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>:</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">0:6</annotation></semantics></math> ，只有 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="monospace">𝟶𝚡𝟶</mtext><mo>,</mo><mtext mathvariant="monospace">𝟶𝚡𝟷</mtext><mo>,</mo><mtext mathvariant="monospace">𝟶𝚡𝟸</mtext></mrow><annotation encoding="application/x-tex">\texttt{0x0},\texttt{0x1},\texttt{0x2}</annotation></semantics></math> 三种取值，分别表示该 PCIe 设备是一个 General Device, PCI-to-PCI bridge, PCI-to-Cardbus bridge ，对于 XHCI 设备，其 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Header Type</mtext><annotation encoding="application/x-tex">\text{Header Type}</annotation></semantics></math> 值一定为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟶𝚡𝟶</mtext><annotation encoding="application/x-tex">\texttt{0x0}</annotation></semantics></math> 或 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟶𝚡𝟾𝟶</mtext><annotation encoding="application/x-tex">\texttt{0x80}</annotation></semantics></math> 。而上述展示的PCIe表结构就是 Bit <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>:</mo><mn>6</mn><mo>=</mo><mtext mathvariant="monospace">𝟶𝚡𝟶</mtext></mrow><annotation encoding="application/x-tex">0:6=\texttt{0x0}</annotation></semantics></math> 时的结构，对于其他情况，可以参考 <a href="https://wiki.osdev.org/PCI">PCI on OS Dev</a> 。</p>
<h2 id="xhci">XHCI</h2>
<h3 id="capability-registers">Capability Registers</h3>
<p>可以翻译为使能寄存器组，这些寄存器均为只读(RO)寄存器。其基地址可以使用 <code>PCIeConfig</code> 的 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">bar0</mtext><mo>,</mo><mtext mathvariant="normal">bar1</mtext></mrow><annotation encoding="application/x-tex">\text{bar0}, \text{bar1}</annotation></semantics></math> 组合获取，计算方式如下：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="co">// 将两个地址的值拼接起来，然后对 4K 下取整对齐</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a>addr=(bar0 | (bar1 &lt;&lt; <span class="dv">32</span>)) &amp; (~((<span class="dv">1</span> &lt;&lt; <span class="dv">12</span>) - <span class="dv">1</span>))</span></code></pre></div>
<p>这个 <code>addr</code> 可以记录为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">BaseAddr</mtext><annotation encoding="application/x-tex">\text{BaseAddr}</annotation></semantics></math> ，稍后依然会用到。接下来直接列出这些寄存器的信息：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Offset</th>
<th style="text-align: center;">Size(Byte)</th>
<th style="text-align: center;">Name</th>
<th style="text-align: center;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0x0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">CapLen</td>
<td style="text-align: center;">使能寄存器组的大小</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">RSVD</td>
<td style="text-align: center;">保留</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x2</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">hciVersion</td>
<td style="text-align: center;">接口的版本数字，不需要关注</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x4</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">hcsParams1</td>
<td style="text-align: center;">结构化的参数组 #1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x8</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">hcsParams2</td>
<td style="text-align: center;">结构化的参数组 #2</td>
</tr>
<tr class="even">
<td style="text-align: center;">0xc</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">hcsParams3</td>
<td style="text-align: center;">结构化的参数组 #3</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x10</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">hccParams1</td>
<td style="text-align: center;">使能参数组 #1</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x14</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">dbOff</td>
<td style="text-align: center;">Doorbell 寄存器组的偏移（相对于 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">BaseAddr</mtext><annotation encoding="application/x-tex">\text{BaseAddr}</annotation></semantics></math>）</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x18</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">rtsOff</td>
<td style="text-align: center;">运行时寄存器空间的偏移，相对于 （相对于 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">BaseAddr</mtext><annotation encoding="application/x-tex">\text{BaseAddr}</annotation></semantics></math>）</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x1c</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">hccParams2</td>
<td style="text-align: center;">使能参数组 #2</td>
</tr>
</tbody>
</table>
<p>上面的表中提到了五个参数组，实际上就是将一些值比较小的信息拼接起来，节省空间，接下来给出每个参数组的具体内容。</p>
<h4 id="hcsparams-1-结构化的参数组-1">hcsParams 1, 结构化的参数组 #1</h4>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Name</th>
<th style="text-align: center;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:7</td>
<td style="text-align: center;">MaxSlots</td>
<td style="text-align: center;">最大插槽的编号</td>
</tr>
<tr class="even">
<td style="text-align: center;">8:18</td>
<td style="text-align: center;">MaxIntrs</td>
<td style="text-align: center;">最大的中断编号</td>
</tr>
<tr class="odd">
<td style="text-align: center;">19:23</td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: center;">保留</td>
</tr>
<tr class="even">
<td style="text-align: center;">24:31</td>
<td style="text-align: center;">MaxPorts</td>
<td style="text-align: center;">最大端口的编号</td>
</tr>
</tbody>
</table>
<h4 id="hcsparams-2-结构化的参数组-2">hcsParams 2, 结构化的参数组 #2</h4>
<table>
<colgroup>
<col style="width: 23%" />
<col style="width: 38%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Name</th>
<th style="text-align: center;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:3</td>
<td style="text-align: center;">Isochronous Scheduling Threshold (IST)</td>
<td style="text-align: center;">告诉软件它可以在多远的帧中修改 TRH（传输请求块）并且仍能正确执行</td>
</tr>
<tr class="even">
<td style="text-align: center;">4:7</td>
<td style="text-align: center;">Event Ring Segment Table Max (ERST Max)</td>
<td style="text-align: center;">Event Ring Segment Table Base Size registers (稍后会有解释) 可以支持的最大值</td>
</tr>
<tr class="odd">
<td style="text-align: center;">8:20</td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: center;">保留</td>
</tr>
<tr class="even">
<td style="text-align: center;">21:25</td>
<td style="text-align: center;">Max Scractchpad Buffer(High 5 bits)</td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">26</td>
<td style="text-align: center;">Scratchpad Restore(SPR)</td>
<td style="text-align: center;">表示是否支持暂存器保存/恢复缓冲区</td>
</tr>
<tr class="even">
<td style="text-align: center;">27:31</td>
<td style="text-align: center;">Max Scractchpad Buffer(Low 5 bits)</td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<p>将 Max Scractchpad Buffer 拼接起来可以得到软件需要申请的用于暂存器缓冲区的内容大小，如果该值为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> ，那么就不需要申请内容，更多要求则和接下来提到的pageSize的值有关，但是在本人的机子上，这个值都是 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>。</p>
</body>
</html>
