<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>XHCI</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="前言">前言</h1>
<p>本文参考了 <a href="https://wiki.osdev.org/XHCI">XHCI on OS Dev</a> 以及 《USB: The Universal Series Bus》。代码存储于 <code>github.com/juruohejiarui/VCPP-2.git</code> 中的 <code>VOS/kernel/hardware/USB</code> .</p>
<p>需要先简单了解 PCIe 的数据结构和枚举、检测 UEFI 提供的 PCIe 信息的方法。</p>
<p>可以遵循下列步骤设置你的XHCI控制器：</p>
<ol type="1">
<li>找到所有 XHCI 的数据结构</li>
<li>获取所需要的信息，建立所需要的额外的数据结构</li>
<li>重置控制器，并设置控制器</li>
<li>启动控制器</li>
<li>开启监测进程</li>
</ol>
<h1 id="数据结构和注释">数据结构和注释</h1>
<p>XHCI 控制器有大量的寄存器组和描述，需要一定的耐心。但是我们不需要全部了解，只需要知道一些基本的，可以用于设备枚举，检测和通信的寄存器就可以了。但是为了查阅方便，这里我还是几乎完全摘抄了《USB: The Universal Series Bus》对于每一个描述符的解释。当我们需要某些功能的时候再回来查阅表格即可。如果学习过程中发现一些不懂得名词，可以先把它记下来，之后遇到了定义或解释的时候再返回来看，如果之后都没有出现，那么就可以认为它并不重要。</p>
<h2 id="pcie">PCIe</h2>
<p>从 UEFI 提供的 <code>MCFG</code> 表中，可以读出一个 PCIe 数据表头的结构，我们称之为 <code>PCIeConfig</code>，对于 XHCI 设备，其结构一般如下：</p>
<table>
<colgroup>
<col style="width: 17%" />
<col style="width: 29%" />
<col style="width: 29%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Offset</th>
<th style="text-align: center;">Size(Byte)</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0x0</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></td>
<td style="text-align: center;">Vendor ID</td>
<td style="text-align: left;">制造商 ID</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x2</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></td>
<td style="text-align: center;">Device ID</td>
<td style="text-align: left;">制造商申请的设备特定的 ID</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x4</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></td>
<td style="text-align: center;">Command</td>
<td style="text-align: left;">用于操作该PCIe设备的寄存器</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x6</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></td>
<td style="text-align: center;">Status</td>
<td style="text-align: left;">该设备的状态</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x8</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Revision ID</td>
<td style="text-align: left;">我也不懂，应该不太重要，可以忽略</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x9</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Prog IF</td>
<td style="text-align: left;">Program Interface Byte, 只读，用于寄存器级别下指定该设备的类别</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0xa</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Subclass</td>
<td style="text-align: left;">子类 ID</td>
</tr>
<tr class="even">
<td style="text-align: center;">0xb</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Class Id</td>
<td style="text-align: left;">类 ID</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0xc</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Cache Line Size</td>
<td style="text-align: left;">我也不懂，应该不太重要，可以忽略</td>
</tr>
<tr class="even">
<td style="text-align: center;">0xd</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Latency Timer</td>
<td style="text-align: left;">用于PCI，PCIe不支持，固定为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math></td>
</tr>
<tr class="odd">
<td style="text-align: center;">0xe</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Header Type</td>
<td style="text-align: left;">指示该表头剩余内容的结构</td>
</tr>
<tr class="even">
<td style="text-align: center;">0xf</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">BIST</td>
<td style="text-align: left;">Built-in self test, 设备的内建自检状态和控制寄存器</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x10</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Bar0</td>
<td style="text-align: left;">Base Address 0</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x14</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Bar1</td>
<td style="text-align: left;">Base Address <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x18</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Bar2</td>
<td style="text-align: left;">Base Address <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></td>
</tr>
<tr class="even">
<td style="text-align: center;">0x1c</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Bar3</td>
<td style="text-align: left;">Base Address 3</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x20</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Bar4</td>
<td style="text-align: left;">Base Address <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
</tr>
<tr class="even">
<td style="text-align: center;">0x24</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Bar5</td>
<td style="text-align: left;">Base Address 5</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x28</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Cardbus CIS Pointer</td>
<td style="text-align: left;">指向 Cardbus 结构的指针，该值被 PCI 和 Cardbus 共享（机翻）</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x2c</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></td>
<td style="text-align: center;">Subsystem Vendor ID</td>
<td style="text-align: left;">子系统的Vendor ID, 不重要</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x2e</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math></td>
<td style="text-align: center;">subsystem ID</td>
<td style="text-align: left;">子系统ID，不重要</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x30</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">Expansion ROM base address</td>
<td style="text-align: left;">不懂，应该不太重要</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x34</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Capabilities Pointer</td>
<td style="text-align: left;">使能寄存器的偏移量</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x35</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>7</mn><annotation encoding="application/x-tex">7</annotation></semantics></math></td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: left;">保留位置，不能读写</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x3c</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Interrupt Line</td>
<td style="text-align: left;">用于指定该设备连接到 PIC (不是I/O APIC) 的 (IRQ0,IRQ1…IRQ15) 哪个（些）引脚, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟶𝚡𝚏𝚏</mtext><annotation encoding="application/x-tex">\texttt{0xff}</annotation></semantics></math> 则表示无连接</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x3d</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Interrupt PIN</td>
<td style="text-align: left;">用于指定该设备使用哪个中断引脚，<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="monospace">𝟶𝚡𝟶</mtext><mo>→</mo><mtext mathvariant="normal">does not use</mtext><mo>,</mo><mtext mathvariant="monospace">𝟶𝚡𝟷</mtext><mo>→</mo><mtext mathvariant="monospace">𝙸𝙽𝚃𝙰</mtext><mo>,</mo><mtext mathvariant="monospace">𝟶𝚡𝟸</mtext><mo>→</mo><mtext mathvariant="monospace">𝙸𝙽𝚃𝙱</mtext></mrow><annotation encoding="application/x-tex">\texttt{0x0}\rightarrow \text{does not use},\texttt{0x1}\rightarrow \texttt{INTA}, \texttt{0x2}\rightarrow \texttt{INTB}</annotation></semantics></math>, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="monospace">𝟶𝚡𝟹</mtext><mo>→</mo><mtext mathvariant="monospace">𝙸𝙽𝚃𝙲</mtext></mrow><annotation encoding="application/x-tex">\texttt{0x3}\rightarrow \texttt{INTC}</annotation></semantics></math>, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="monospace">𝟶𝚡𝟺</mtext><mo>→</mo><mtext mathvariant="monospace">𝙸𝙽𝚃𝙳</mtext></mrow><annotation encoding="application/x-tex">\texttt{0x4}\rightarrow \texttt{INTD}</annotation></semantics></math></td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x3e</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Min Grant</td>
<td style="text-align: left;">用于 PCI ，PCIe 下不可用，固定为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math></td>
</tr>
<tr class="even">
<td style="text-align: center;">0x3f</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
<td style="text-align: center;">Max Latency</td>
<td style="text-align: left;">用于 PCI ，PCIe 下不可用，固定为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math></td>
</tr>
</tbody>
</table>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Class Id, subClass, Prog IF</mtext><annotation encoding="application/x-tex">\text{Class Id, subClass, Prog IF}</annotation></semantics></math> 三者共同确认一个设备的类别，网上有对照表，这里就不粘出来了。对于 XHCI 设备，<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Class Id</mtext><mo>=</mo><mtext mathvariant="monospace">𝟶𝚡𝙲</mtext><mo>,</mo><mtext mathvariant="normal">Subclass</mtext><mo>=</mo><mtext mathvariant="monospace">𝟶𝚡𝟹</mtext><mo>,</mo><mtext mathvariant="normal">Prog IF</mtext><mo>=</mo><mtext mathvariant="monospace">𝟶𝚡𝟹𝟶</mtext></mrow><annotation encoding="application/x-tex">\text{Class Id}=\texttt{0xC}, \text{Subclass}=\texttt{0x3}, \text{Prog IF}=\texttt{0x30}</annotation></semantics></math></p>
<h3 id="header-type-结构">Header Type 结构</h3>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Bit 7</th>
<th style="text-align: center;">Bit 0 : 6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">该设备是(1)/否(0)为多功能(multi-function)设备</td>
<td style="text-align: center;">表头剩余结构的类型</td>
</tr>
</tbody>
</table>
<p>对于 Bit <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>:</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">0:6</annotation></semantics></math> ，只有 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="monospace">𝟶𝚡𝟶</mtext><mo>,</mo><mtext mathvariant="monospace">𝟶𝚡𝟷</mtext><mo>,</mo><mtext mathvariant="monospace">𝟶𝚡𝟸</mtext></mrow><annotation encoding="application/x-tex">\texttt{0x0},\texttt{0x1},\texttt{0x2}</annotation></semantics></math> 三种取值，分别表示该 PCIe 设备是一个 General Device, PCI-to-PCI bridge, PCI-to-Cardbus bridge ，对于 XHCI 设备，其 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Header Type</mtext><annotation encoding="application/x-tex">\text{Header Type}</annotation></semantics></math> 值一定为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟶𝚡𝟶</mtext><annotation encoding="application/x-tex">\texttt{0x0}</annotation></semantics></math> 或 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟶𝚡𝟾𝟶</mtext><annotation encoding="application/x-tex">\texttt{0x80}</annotation></semantics></math> 。而上述展示的PCIe表结构就是 Bit <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>:</mo><mn>6</mn><mo>=</mo><mtext mathvariant="monospace">𝟶𝚡𝟶</mtext></mrow><annotation encoding="application/x-tex">0:6=\texttt{0x0}</annotation></semantics></math> 时的结构，对于其他情况，可以参考 <a href="https://wiki.osdev.org/PCI">PCI on OS Dev</a> 。</p>
<h2 id="capability-registers">Capability Registers</h2>
<p>可以翻译为使能寄存器组，这些寄存器均为只读(RO)寄存器。存储了大量的控制器支持信息。其基地址可以使用 <code>PCIeConfig</code> 的 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">bar0</mtext><mo>,</mo><mtext mathvariant="normal">bar1</mtext></mrow><annotation encoding="application/x-tex">\text{bar0}, \text{bar1}</annotation></semantics></math> 组合获取，计算方式如下：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="co">// 将两个地址的值拼接起来，然后对 4K 下取整对齐</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a>addr=(bar0 | (bar1 &lt;&lt; <span class="dv">32</span>)) &amp; (~((<span class="dv">1</span> &lt;&lt; <span class="dv">12</span>) - <span class="dv">1</span>))</span></code></pre></div>
<p>这个 <code>addr</code> 可以记录为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">baseAddr</mtext><annotation encoding="application/x-tex">\text{baseAddr}</annotation></semantics></math> ，稍后依然会用到。接下来直接列出这些寄存器的信息：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Offset</th>
<th style="text-align: center;">Size(Byte)</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0x0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">CapLen</td>
<td style="text-align: left;">使能寄存器组的大小</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">RSVD</td>
<td style="text-align: left;">保留</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x2</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">hciVersion</td>
<td style="text-align: left;">接口的版本数字，不需要关注</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x4</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">hcsParams1</td>
<td style="text-align: left;">结构化的参数组 #1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x8</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">hcsParams2</td>
<td style="text-align: left;">结构化的参数组 #2</td>
</tr>
<tr class="even">
<td style="text-align: center;">0xc</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">hcsParams3</td>
<td style="text-align: left;">结构化的参数组 #3</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x10</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">hccParams1</td>
<td style="text-align: left;">使能参数组 #1</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x14</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">dbOff</td>
<td style="text-align: left;">Doorbell 寄存器组的偏移，对 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math> 对齐（相对于 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">baseAddr</mtext><annotation encoding="application/x-tex">\text{baseAddr}</annotation></semantics></math>）</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x18</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">rtsOff</td>
<td style="text-align: left;">运行时寄存器空间的偏移，对 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>64</mn><annotation encoding="application/x-tex">64</annotation></semantics></math> 对齐（相对于 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">baseAddr</mtext><annotation encoding="application/x-tex">\text{baseAddr}</annotation></semantics></math>）</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x1c</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">hccParams2</td>
<td style="text-align: left;">使能参数组 #2</td>
</tr>
</tbody>
</table>
<p>上面的表中提到了五个参数组，实际上就是将一些值比较小的信息拼接起来，节省空间，接下来给出每个参数组的具体内容。</p>
<h3 id="hcsparams-1-结构化的参数组-1">hcsParams 1, 结构化的参数组 #1</h3>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:7</td>
<td style="text-align: center;">MaxSlots</td>
<td style="text-align: left;">最大插槽的编号</td>
</tr>
<tr class="even">
<td style="text-align: center;">8:18</td>
<td style="text-align: center;">MaxIntrs</td>
<td style="text-align: left;">最大的中断编号</td>
</tr>
<tr class="odd">
<td style="text-align: center;">19:23</td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: left;">保留</td>
</tr>
<tr class="even">
<td style="text-align: center;">24:31</td>
<td style="text-align: center;">MaxPorts</td>
<td style="text-align: left;">最大端口的编号</td>
</tr>
</tbody>
</table>
<p>这三个最大值可以用于枚举端口和中断，但注意，可用的端口和选择使用的中断可能并不连续。</p>
<h3 id="hcsparams-2-结构化的参数组-2">hcsParams 2, 结构化的参数组 #2</h3>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 40%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:3</td>
<td style="text-align: center;">Isochronous Scheduling Threshold (IST)</td>
<td style="text-align: left;">告诉软件它可以在多远的帧中修改 TRB（传输请求块）并且仍能正确执行</td>
</tr>
<tr class="even">
<td style="text-align: center;">4:7</td>
<td style="text-align: center;">Event Ring Segment Table Max (ERST Max)</td>
<td style="text-align: left;">Event Ring Segment Table Base Size registers (稍后会有解释) 可以支持的最大值</td>
</tr>
<tr class="odd">
<td style="text-align: center;">8:20</td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: left;">保留</td>
</tr>
<tr class="even">
<td style="text-align: center;">21:25</td>
<td style="text-align: center;">Max Scractchpad Buffer (High 5 bits)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">26</td>
<td style="text-align: center;">Scratchpad Restore (SPR)</td>
<td style="text-align: left;">表示是否支持暂存器保存/恢复缓冲区</td>
</tr>
<tr class="even">
<td style="text-align: center;">27:31</td>
<td style="text-align: center;">Max Scractchpad Buffer (Low 5 bits)</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<p>将 Max Scractchpad Buffer 拼接起来可以得到软件需要申请的用于暂存器缓冲区的内容大小，如果该值为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> ，那么就不需要申请内容，更多要求则和接下来提到的pageSize的值有关，但是在本人的机子上，这个值都是 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>。</p>
<h3 id="hcsparams-3-结构化的参数组-3">hcsParams 3, 结构化的参数组 #3</h3>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:7</td>
<td style="text-align: center;">U1 Device Exit Latency</td>
<td style="text-align: left;">电源状态从 U1 到 U0 所需要的微秒数 (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mrow><mo>−</mo><mn>6</mn></mrow></msup><mi>s</mi><mo>=</mo><mn>1</mn><mi>μ</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">10^{-6}s=1\mu s</annotation></semantics></math>)</td>
</tr>
<tr class="even">
<td style="text-align: center;">8:15</td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: left;">保留</td>
</tr>
<tr class="odd">
<td style="text-align: center;">16:31</td>
<td style="text-align: center;">U2 Device Exit Latency</td>
<td style="text-align: left;">电源状态从 U1 到 U0 所需要的微秒数</td>
</tr>
</tbody>
</table>
<h3 id="hccparams-1-使能参数组-1">hccParams 1, 使能参数组 #1</h3>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 40%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">64-bit Addressing Capability (AC64)</td>
<td style="text-align: left;">该XHCI控制器是(1)否(0)可以使用64-bit地址，如果不能，那么接下来使用的所有地址，都会忽略高32位。</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">BW Negotiation Capability (BNC)</td>
<td style="text-align: left;">用于指示该控制器是(1)否(0)实现了 Bandwidth Negotiation</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">Context Size (CSZ)</td>
<td style="text-align: left;">指示上下文的大小 1: 64-byte; 0: 32-byte 。该位对 Stream Contexts 不生效。</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">Port Power Control (PPC)</td>
<td style="text-align: left;">1: 所有的端口永远处于通电状态；0: 每个端口可以自行控制供电状态</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">Port Indicators (PIND)</td>
<td style="text-align: left;">用于指示端口指示灯的控制。0: 控制不可用; 1: 参照端口寄存器的 Bit 14:15 来获取更多信息</td>
</tr>
<tr class="even">
<td style="text-align: center;">5</td>
<td style="text-align: center;">Light HC Reset Capability (LHRC)</td>
<td style="text-align: left;">指示操作寄存器组中的 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">usbCmd</mtext><annotation encoding="application/x-tex">\text{usbCmd}</annotation></semantics></math> 寄存器的 Light Host Controller 功能是(1)否(0)可用</td>
</tr>
<tr class="odd">
<td style="text-align: center;">6</td>
<td style="text-align: center;">Latency Tolerance Messaging Capability (LTC)</td>
<td style="text-align: left;">表示该控制器是(1)否(0)支持传递延迟容忍消息(Latency Tolerance Messageing, LTM)</td>
</tr>
<tr class="even">
<td style="text-align: center;">7</td>
<td style="text-align: center;">No Secondary SID Support (NSS)</td>
<td style="text-align: left;"><strong>是(0)否(1)</strong> 支持 Secondary Stream IDs.</td>
</tr>
<tr class="odd">
<td style="text-align: center;">8</td>
<td style="text-align: center;">Parse All Event Data (PAE)</td>
<td style="text-align: left;">1: 当转移到下一个传输描述符的时候，所有的 TRB 都会被解析；0: 不会。检测到一个 Short Packet 的时候会使用这个位</td>
</tr>
<tr class="even">
<td style="text-align: center;">9</td>
<td style="text-align: center;">Stopped - Short Packet Capability (SPC)</td>
<td style="text-align: left;">该控制器是(1)否(0)可以发出短数据包停止代码(Stopped-Short Packet Completion code)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">10</td>
<td style="text-align: center;">Stopped EDTLA Capability (SEC)</td>
<td style="text-align: left;">该控制器是(1)否(0)在 Stream Context 中实现了 Stopped EDTLA 区域，对于较新的硬件，这一位都是 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>。</td>
</tr>
<tr class="even">
<td style="text-align: center;">11</td>
<td style="text-align: center;">Continuous Frame ID Capability (CFC)</td>
<td style="text-align: left;">该控制器是(1)否(0)能够匹配连续 ISO 传输描述符的 ID。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">12:15</td>
<td style="text-align: center;">Maximum Primary Stream Array Size (MaxPSASize)</td>
<td style="text-align: left;">允许的最大 Stream Array 大小</td>
</tr>
<tr class="even">
<td style="text-align: center;">16:31</td>
<td style="text-align: center;">XHCI Extended Capabilities Pointer (xECP)</td>
<td style="text-align: left;">0: 该控制器不存在拓展使能描述; <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">&gt;0</annotation></semantics></math>: 拓展使能描述的偏移（相对于 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">baseAddr</mtext><annotation encoding="application/x-tex">\text{baseAddr}</annotation></semantics></math> ）</td>
</tr>
</tbody>
</table>
<p>实际上的 Stream Array 最大大小需要使用如下方式计算 :</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">maxSize</mtext><mo>=</mo><msup><mn>2</mn><mrow><mtext mathvariant="normal">MaxPSASize</mtext><mo>+</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">
\text{maxSize}=2^{\text{MaxPSASize}+1}
</annotation></semantics></math></p>
<p>对于拓展时能描述的偏移实际上是：</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">offset of extended Capabilites</mtext><mo>=</mo><mtext mathvariant="normal">baseAddr</mtext><mo>+</mo><mn>4</mn><mo>×</mo><mtext mathvariant="normal">xECP</mtext></mrow><annotation encoding="application/x-tex">
\text{offset of extended Capabilites}=\text{baseAddr} + 4\times \text{xECP}
</annotation></semantics></math></p>
<h3 id="hccparams-2-使能参数组-2">hccParams 2, 使能参数组 #2</h3>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 40%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">U3 Entry Capability</td>
<td style="text-align: left;">根(root hub)是否支持暂停完成通知(Suspend Completion notification)</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">ConfigEP Command Max Exit Latency too Large (CMC)</td>
<td style="text-align: left;">是(1)否(0)可以生成最大退出潜伏期过长的兼容错误(Exit Latency too Large compatibility error)，该位被操作寄存器的 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">usbCmd</mtext><annotation encoding="application/x-tex">\text{usbCmd}</annotation></semantics></math> 的 CME 位使用。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">Force Save Context Capability (FSC)</td>
<td style="text-align: left;">Save State命令是(1)否(0)应当将所有的cached Slot, End Point, Stream和其他上下文存储到内存中</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">Compliance Transition Capability (CTC)</td>
<td style="text-align: left;">该控制器是(1)否(0) 支持 Compliance Transition Enabled 位</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">Large ESIT Payload Capability (LEC)</td>
<td style="text-align: left;">是(1)否(0)支持大于 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>48</mn><mtext mathvariant="monospace">𝙺𝚋</mtext></mrow><annotation encoding="application/x-tex">48\texttt{Kb}</annotation></semantics></math> 的 ESIT Payloads</td>
</tr>
<tr class="even">
<td style="text-align: center;">5</td>
<td style="text-align: center;">Configuration Information Capability</td>
<td style="text-align: left;">是(1)否(0)支持 输入控制上下文块(Input Control Context block) 中的 Configuration Value, Interface Number 和 Alternate settings 域的拓展配置信息</td>
</tr>
</tbody>
</table>
<h2 id="extended-capabilites-list">Extended Capabilites List</h2>
<p>除了上面的 Capability Registers，XHCI 还提供了链表结构的拓展使能列表，和 PCIe 非常类似。每个拓展描述符都长下面这样：</p>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 40%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:7</td>
<td style="text-align: center;">ID</td>
<td style="text-align: left;">RO, 该拓展描述符的 ID</td>
</tr>
<tr class="even">
<td style="text-align: center;">8:15</td>
<td style="text-align: center;">Next</td>
<td style="text-align: left;">RO, 下一个拓展描述符相对于当前描述符的偏移，计算方式如下：<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">next offset</mtext><mo>=</mo><mtext mathvariant="normal">current offset</mtext><mo>+</mo><mn>4</mn><mo>×</mo><mtext mathvariant="normal">Next</mtext></mrow><annotation encoding="application/x-tex">\text{next offset}=\text{current offset} + 4\times \text{Next}</annotation></semantics></math></td>
</tr>
<tr class="odd">
<td style="text-align: center;">n</td>
<td style="text-align: center;">Varies</td>
<td style="text-align: left;">每个 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">ID</mtext><annotation encoding="application/x-tex">\text{ID}</annotation></semantics></math> 特定的内容</td>
</tr>
</tbody>
</table>
<p>下面给出一些常用的 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">ID</mtext><annotation encoding="application/x-tex">\text{ID}</annotation></semantics></math> 对照表：</p>
<table style="width:100%;">
<colgroup>
<col style="width: 20%" />
<col style="width: 33%" />
<col style="width: 30%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">ID</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Size(Byte)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: left;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">USB Legacy Support</td>
<td style="text-align: left;">提供操作系统启动前，既UEFI或BIOS的支持。如果这个拓展描述符是 USB Legacy Support，那么它一定是第一个拓展描述符。(书上是这么说的，但是貌似并不是这样的)</td>
<td style="text-align: center;">8</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">Supported Protocol</td>
<td style="text-align: left;">该控制器支持的其中一种协议，每个控制器至少有一个这种拓展描述符，并且可能有多个。</td>
<td style="text-align: center;">16</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">Extened Power Management</td>
<td style="text-align: left;">拓展的电源管理，至少有一个。</td>
<td style="text-align: center;">n</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">I/O Virtualization</td>
<td style="text-align: left;">硬件虚拟化支持</td>
<td style="text-align: center;">最高 1280</td>
</tr>
<tr class="even">
<td style="text-align: center;">5</td>
<td style="text-align: center;">Message Interrupt</td>
<td style="text-align: left;">信息中断的支持</td>
<td style="text-align: center;">n</td>
</tr>
<tr class="odd">
<td style="text-align: center;">6</td>
<td style="text-align: center;">Local Memory</td>
<td style="text-align: left;">本地内存支持</td>
<td style="text-align: center;">最高 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mtext mathvariant="monospace">𝚃𝙱</mtext></mrow><annotation encoding="application/x-tex">4\texttt{TB}</annotation></semantics></math></td>
</tr>
<tr class="even">
<td style="text-align: center;">7-9</td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: left;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">10</td>
<td style="text-align: center;">USB Debug Capability</td>
<td style="text-align: left;">调试功能支持</td>
<td style="text-align: center;">56</td>
</tr>
<tr class="even">
<td style="text-align: center;">11-16</td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: left;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">17</td>
<td style="text-align: center;">Extended Message Interrupt</td>
<td style="text-align: left;">拓展的信息中断的支持</td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">18-191</td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: left;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">192-255</td>
<td style="text-align: center;">Vendor Specific</td>
<td style="text-align: left;">特定的Vendor所使用的拓展使能信息</td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<p>VMware 虚拟机的 XHCI 控制器似乎并不存在 USB Legacy Support 描述符。</p>
<p>每个XHCI控制器，至少拥有一个 Message Interrupt 或者 Extended Message Interrupt 描述符。一般而言，有 Extended Message Interrupt 则使用 Extend Message Interrupt，否则使用 Message Interrupt 。</p>
<h3 id="xhci-usb-legacy-support">XHCI USB Legacy Support</h3>
<p>整一个描述符可以使用一个 64 位整数存储，但是为了便于展示，将其分成两个 32 位整数。</p>
<p>对于第一个整数：</p>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 40%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:7</td>
<td style="text-align: center;">ID</td>
<td style="text-align: left;">RO, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mtext mathvariant="monospace">𝟶𝚡𝟷</mtext></mrow><annotation encoding="application/x-tex">=\texttt{0x1}</annotation></semantics></math></td>
</tr>
<tr class="even">
<td style="text-align: center;">8:15</td>
<td style="text-align: center;">Next</td>
<td style="text-align: left;">RO</td>
</tr>
<tr class="odd">
<td style="text-align: center;">16</td>
<td style="text-align: center;">HC BIOS Owned Semaphore</td>
<td style="text-align: left;">R/W, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Default</mtext><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\text{Default}=0</annotation></semantics></math>. BIOS 将此位设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 来指示 BIOS 占用了该控制器。</td>
</tr>
<tr class="even">
<td style="text-align: center;">17:23</td>
<td style="text-align: center;">Reserved and preserved</td>
<td style="text-align: left;">R/W</td>
</tr>
<tr class="odd">
<td style="text-align: center;">24</td>
<td style="text-align: center;">System Software Owned Semaphore</td>
<td style="text-align: left;">R/W, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Default</mtext><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\text{Default}=0</annotation></semantics></math>，操作系统将此位设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 来获取这个控制器的所有权，设置之后，待到 Bit 16 变为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> 即表示所有权获取成功</td>
</tr>
<tr class="even">
<td style="text-align: center;">25:31</td>
<td style="text-align: center;">Reserved and preserved</td>
<td style="text-align: left;">R/W</td>
</tr>
</tbody>
</table>
<p>对于要求 Reserved and preserved 的位置，需要每次写入的之前先把这些Bit的值读出来，或上要写入的其他位置的值，然后再将整个整数写入。</p>
<p>第二个整数的值被 BIOS 使用，操作系统软件无需关注。对于这个拓展描述符，唯一要做的就是将第一个整数的 Bit 24 设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> ，然后等待 Bit 16 变为零即可。</p>
<h3 id="xhci-usb-supported-protocol-capability">XHCI USB Supported Protocol Capability</h3>
<p>本拓展描述符用于描述控制器支持的其中一种协议，以及对应的端口序列。类似的，我们用 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math> 个 32 位整数描述这个描述符：</p>
<p>对于第一个整数：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Access</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:15</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">ID 和 Next</td>
</tr>
<tr class="even">
<td style="text-align: center;">16:23</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Minor Revision Number, “USB 3.0” 中的 0</td>
</tr>
<tr class="odd">
<td style="text-align: center;">24:27</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Reserved</td>
</tr>
<tr class="even">
<td style="text-align: center;">28:31</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Major Revision Number, “USB 3.0” 中的 3</td>
</tr>
</tbody>
</table>
<p>注意，Minor Revision Number 和 Major Revision Number 均为整数，而不是字符 。在VMware 的 USB 3.1 控制器中，其中一个拓展描述符有 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Major Revision Number</mtext><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">\text{Major Revision Number}=3</annotation></semantics></math>, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Minor Revision Number</mtext><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\text{Minor Revision Number}=1</annotation></semantics></math> ，而另一个拓展描述符有 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Major Revision Number</mtext><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">\text{Major Revision Number}=2</annotation></semantics></math>, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Minor Revision Number</mtext><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\text{Minor Revision Number}=0</annotation></semantics></math> ，也就是说VMware的XHCI支持 USB 3.1 和 USB 2.0 两种协议。</p>
<p>第二个整数可以视为长度为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math> 的字符串，其值一定为 “USB” 。</p>
<p>第三个整数存储了支持该协议的端口，</p>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 40%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Access</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:7</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Compatible Port Offset，兼容该协议的端口的偏移，也就是从第几个端口开始支持这种协议</td>
</tr>
<tr class="even">
<td style="text-align: center;">8:15</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Compatible Port Count，兼容该协议的端口数量</td>
</tr>
<tr class="odd">
<td style="text-align: center;">16:27</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Protocol Defined，对于 USB 3.0 ，该段表示 Hub Depth；对于 USB 2.0，Bit 17 表示该控制器是(1)否(0)只支持高速设备，剩余位用于表示 Hub Depth。详细内容可以查询 XHCI 技术手册的 Section 7.2.2.1.3</td>
</tr>
<tr class="even">
<td style="text-align: center;">28:31</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Protocol Speed ID Count，<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">&gt;0</annotation></semantics></math>：表示用于定义 被该控制器支持的速度类型 的 PSI 结构的 32 位整数的个数。</td>
</tr>
</tbody>
</table>
<p>对于第四个整数，只有 XHCI 1.1 或更新版本才有定义，否则所有位均为 Reserved and preserved 。</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Access</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0：4</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Slot Type ，插槽类型，目前只支持 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math></td>
</tr>
<tr class="even">
<td style="text-align: center;">5:31</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Reserved and preserved</td>
</tr>
</tbody>
</table>
<h2 id="operational-registers操作寄存器组">Operational Registers，操作寄存器组</h2>
<p>这一组寄存器用于整个控制器的操作，包括重置，上电/断电等等。可以使用 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">opRegAddr</mtext><mo>=</mo><mtext mathvariant="normal">baseAddr</mtext><mo>+</mo><mtext mathvariant="normal">capReg</mtext><mi>.</mi><mtext mathvariant="normal">capLen</mtext></mrow><annotation encoding="application/x-tex">\text{opRegAddr}=\text{baseAddr}+\text{capReg}.\text{capLen}</annotation></semantics></math> 获取这组寄存器的地址。若寄存器为 32 位，那么只能用读写 32 位整数的方法对其操作；只可以使用 64 位整数的操作方法对 64 位寄存器进行操作。这里涉及到 C 语言编译出的汇编码的限制，使用优化的时候需要注意。</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Offset</th>
<th style="text-align: center;">Size(Byte)</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0x0</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">usbCmd</td>
<td style="text-align: left;">用于操作控制器的寄存器</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x4</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">usbState</td>
<td style="text-align: left;">用于指示控制器状态的寄存器</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x8</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">pageSize</td>
<td style="text-align: left;">用于指示可用的地址的页大小的寄存器</td>
</tr>
<tr class="even">
<td style="text-align: center;">0xC</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>8</mn><annotation encoding="application/x-tex">8</annotation></semantics></math></td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: left;">保留</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x14</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">devNotifCtrl</td>
<td style="text-align: left;">Device Notification Control，用于控制控制器的报告内容的寄存器</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x18</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>8</mn><annotation encoding="application/x-tex">8</annotation></semantics></math></td>
<td style="text-align: center;">cmdRingCtrl</td>
<td style="text-align: left;">Command Ring Control</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x20</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>8</mn><annotation encoding="application/x-tex">8</annotation></semantics></math></td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: left;">保留</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x30</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>8</mn><annotation encoding="application/x-tex">8</annotation></semantics></math></td>
<td style="text-align: center;">devCtxBaseAddr</td>
<td style="text-align: left;">Device Context Base Address，用于保存上下文结构的基地址</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x38</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math></td>
<td style="text-align: center;">config</td>
<td style="text-align: left;">Configuration，配置</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x3c</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>964</mn><annotation encoding="application/x-tex">964</annotation></semantics></math></td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: left;">保留</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x400</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn><mi>n</mi></mrow><annotation encoding="application/x-tex">16n</annotation></semantics></math></td>
<td style="text-align: center;">PortRegs</td>
<td style="text-align: left;">端口的寄存器组集合</td>
</tr>
</tbody>
</table>
<p>下一个小结会解释端口寄存器组的数据结构。</p>
<h3 id="usbcmd对控制器的命令">usbCmd，对控制器的命令</h3>
<p>对这个寄存器写入之后不一定立刻有效果。因此写入之后需要保证该位被成功设置。</p>
<table>
<colgroup>
<col style="width: 17%" />
<col style="width: 28%" />
<col style="width: 28%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Access</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Run/Stop (RS)</td>
<td style="text-align: left;">Run(1);Stop(0)，写入 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> 之后，需要等到 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">usbState</mtext><annotation encoding="application/x-tex">\text{usbState}</annotation></semantics></math> 中的 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">usbHalted</mtext><annotation encoding="application/x-tex">\text{usbHalted}</annotation></semantics></math> 位被成功置位才算完成操作。</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Host Controller Reset (HCRST)</td>
<td style="text-align: left;">重置。将操作寄存器组的所有寄存器设为默认值，将所有的 Transaction 设置为停止状态(Halt)。对 USB2.0 下游设备无效；使 USB3.0 设备进行 热重置 (Hot Reset) 或温重置 (Warm Reset) 。需要保证 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">usbHalted</mtext><annotation encoding="application/x-tex">\text{usbHalted}</annotation></semantics></math> 位在重置之前已经被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 。重置完成之后这一位会被复位成 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> 。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Interrupter Enable (INTE)</td>
<td style="text-align: left;">是(1)否(0)能让中断器移动到下一个中断临界点 (Interrupt threshold)，<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">=0</annotation></semantics></math>：禁用中断</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Host System Error Enable (HSEE)</td>
<td style="text-align: left;">是(1)否(0)允许当 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">usbState</mtext><annotation encoding="application/x-tex">\text{usbState}</annotation></semantics></math> 的 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">HSE</mtext><annotation encoding="application/x-tex">\text{HSE}</annotation></semantics></math> 位被设为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 的时候触发中断</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4:6</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Reserved and Preserved</td>
<td style="text-align: left;">保留</td>
</tr>
<tr class="even">
<td style="text-align: center;">7</td>
<td style="text-align: center;">R/W or RO</td>
<td style="text-align: center;">Light Host Controller Reset (LHCRST)</td>
<td style="text-align: left;">如果 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">hccParams1</mtext><annotation encoding="application/x-tex">\text{hccParams1}</annotation></semantics></math> 的 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">LHRC</mtext><annotation encoding="application/x-tex">\text{LHRC}</annotation></semantics></math> 位为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> ，那么为 R/W，可以用于重置灯组寄存器，重置完成之后被复位为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> ；如果为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> ，那么这一位为 RO 位</td>
</tr>
<tr class="odd">
<td style="text-align: center;">8</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Controller Save State (CSS)</td>
<td style="text-align: left;">用于指示是否将状态存储到操作系统申请得到的 Scratch buffers 中。在设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 之前，需要保证 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">usbHalted</mtext><annotation encoding="application/x-tex">\text{usbHalted}</annotation></semantics></math> 位为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> ，保存过程中，<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">usbState</mtext><annotation encoding="application/x-tex">\text{usbState}</annotation></semantics></math> 中的 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Save State Status</mtext><annotation encoding="application/x-tex">\text{Save State Status}</annotation></semantics></math> 位会被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 。</td>
</tr>
<tr class="even">
<td style="text-align: center;">9</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Controller Restore State (CRS)</td>
<td style="text-align: left;">用于指示是否从 Scratch buffer 中恢复状态，在设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 之前，需要保证 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">usbHalted</mtext><annotation encoding="application/x-tex">\text{usbHalted}</annotation></semantics></math> 位为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 。类似的，用 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">usbState</mtext><annotation encoding="application/x-tex">\text{usbState}</annotation></semantics></math> 中的 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Restore State Status</mtext><annotation encoding="application/x-tex">\text{Restore State Status}</annotation></semantics></math> 位表示是否恢复完成， 恢复时被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">10</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Enable Wrap Event (EWE)</td>
<td style="text-align: left;">是(1)否(0)在 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">MFINDEX</mtext><annotation encoding="application/x-tex">\text{MFINDEX}</annotation></semantics></math> 寄存器从 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟶𝚡𝟹𝚏𝚏𝚏</mtext><annotation encoding="application/x-tex">\texttt{0x3fff}</annotation></semantics></math> 变为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟶𝚡𝟶𝟶𝟶𝟶</mtext><annotation encoding="application/x-tex">\texttt{0x0000}</annotation></semantics></math> 时候触发中断</td>
</tr>
<tr class="even">
<td style="text-align: center;">11</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Enable U3 MFINDEX Stop (EU3S)</td>
<td style="text-align: left;">是(1)否(0)在 通电状态处于 U3 的时候停止 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝙼𝙵𝙸𝙽𝙳𝙴𝚇</mtext><annotation encoding="application/x-tex">\texttt{MFINDEX}</annotation></semantics></math> 寄存器</td>
</tr>
<tr class="odd">
<td style="text-align: center;">12</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Stopped Short Packet Enable (SPE)</td>
<td style="text-align: left;">是(1)否(0)产生发出短数据包停止代码(Stopped-Short Packet Completion code)</td>
</tr>
<tr class="even">
<td style="text-align: center;">13</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">CEM Enable (CME)</td>
<td style="text-align: left;">是(1)否(0)可以在 Configuration Endpoint Command 指令被接受并产生错误的时候，返回 最大退出潜伏期过长的兼容错误(Exit Latency too Large compatibility error)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">14:31</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Reserved and preserved</td>
<td style="text-align: left;">保留</td>
</tr>
</tbody>
</table>
<h3 id="usbstate控制器的状态">usbState，控制器的状态</h3>
<p>这里要解释一下 WC 即 Write Clear 的意思：当某一位被写入 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> 的时候，不会改变该位的值，当写入 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 的时候，该位变为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> 。</p>
<table>
<colgroup>
<col style="width: 17%" />
<col style="width: 28%" />
<col style="width: 28%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Access</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">RO</td>
<td style="text-align: center;">HCHalted</td>
<td style="text-align: left;">控制器是否因为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">RS</mtext><annotation encoding="application/x-tex">\text{RS}</annotation></semantics></math> 位被设置，或者控制器产生错误而停止。</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Reserved and preserved</td>
<td style="text-align: left;">保留</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: center;">Host System Error (HSE)</td>
<td style="text-align: left;">当控制器产生严重错误的时候被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> ，否则为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> 。</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: center;">Event Interrupt (EINT)</td>
<td style="text-align: left;">当任何一个中断器的 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Interrupt Pending</mtext><annotation encoding="application/x-tex">\text{Interrupt Pending}</annotation></semantics></math> 位被设置的时候，这一位被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>，否则为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> 。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: center;">Port Change Detected (PCD)</td>
<td style="text-align: left;">当控制器的任何一个端口的连接状态位从 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> 变为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 的时候，这一位被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>，否则为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> 。</td>
</tr>
<tr class="even">
<td style="text-align: center;">5:7</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Reserved and preserved</td>
<td style="text-align: left;">保留</td>
</tr>
<tr class="odd">
<td style="text-align: center;">8</td>
<td style="text-align: center;">RO</td>
<td style="text-align: center;">Save State Status (SSS)</td>
<td style="text-align: left;">当保存状态的操作处于进行时，这一位被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>，保存完成之后会被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> 。</td>
</tr>
<tr class="even">
<td style="text-align: center;">9</td>
<td style="text-align: center;">RO</td>
<td style="text-align: center;">Restore State Status (RSS)</td>
<td style="text-align: left;">当恢复状态的操作处于进行时，这一位被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>，恢复完成之后会被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> 。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">10</td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: center;">Save/Restore Error (SRE)</td>
<td style="text-align: left;">表示保存状态/恢复状态的操作是(1)否(0)产生错误。</td>
</tr>
<tr class="even">
<td style="text-align: center;">11</td>
<td style="text-align: center;">RO</td>
<td style="text-align: center;">Controller Not Ready (CNR)</td>
<td style="text-align: left;">如果被设置，则禁止对操作寄存器组（除了 $）或Doorbell寄存器组进行任何写入操作。当处于“重置中”时，这一位会被设置。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">12</td>
<td style="text-align: center;">RO</td>
<td style="text-align: center;">Host Controller Error (HCE)</td>
<td style="text-align: left;">表示是(1)否(0)发生外部错误，需要重置和重新初始化控制器。</td>
</tr>
<tr class="even">
<td style="text-align: center;">13:31</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Reserved and preserved</td>
<td style="text-align: left;">保留</td>
</tr>
</tbody>
</table>
<h3 id="pagesize该控制器支持的页大小">pageSize，该控制器支持的页大小</h3>
<p>该寄存器的 Bit 16:31 为保留位，对于 Bit 0:15 ，如果其中的 Bit <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math> 被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> ，则表示该控制器支持大小为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mrow><mi>x</mi><mo>+</mo><mn>12</mn></mrow></msup><mtext mathvariant="monospace">𝙱</mtext></mrow><annotation encoding="application/x-tex">2^{x+12} \texttt{B}</annotation></semantics></math> 的物理页 。在本人的机子上，均有 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">pageSize</mtext><mo>∩</mo><mtext mathvariant="monospace">𝟶𝚡𝚏𝚏𝚏𝚏</mtext><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\text{pageSize}\cap\texttt{0xffff}=0</annotation></semantics></math> 。可以使用如下计算方法直接获得实际大小:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a>size = (pageSize &amp; <span class="bn">0xffff</span><span class="bu">ul</span>) &lt;&lt; <span class="dv">12</span></span></code></pre></div>
<h3 id="devnotifctrl控制器接受通知包的控制寄存器">devNotifCtrl，控制器接受通知包的控制寄存器</h3>
<p>该寄存器的 Bit 16:31 为保留位，对于 Bit 0:15 ，如果其中的 Bit <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math> 被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> ，则表示激活第 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math> 种通知类型。</p>
<h3 id="cmdringctrl指令环的控制寄存器">cmdRingCtrl，指令环的控制寄存器</h3>
<table>
<colgroup>
<col style="width: 17%" />
<col style="width: 28%" />
<col style="width: 28%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Access</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Ring Cycle State (RCS)</td>
<td style="text-align: left;">告知控制器携带一个设置位(set bit)或者一个清理位(clear bit)来开始处理指令环</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: center;">Command Stop (CS)</td>
<td style="text-align: left;">告知控制器是否停止处理指令环。在处理完成当前指令之后会停止处理指令环，然后在事件环中放入一个任务环停止事件 (Command Ring Stopped event)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: center;">Command Abort (CA)</td>
<td style="text-align: left;">直接停止处理指令环，然后放入一个任务环停止事件 (Command Ring Stopped event)</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">RO</td>
<td style="text-align: center;">Command Ring Running (CRR)</td>
<td style="text-align: left;">表示当前是否在处理指令环</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4:5</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Reserved and preserved</td>
<td style="text-align: left;">保留</td>
</tr>
<tr class="even">
<td style="text-align: center;">6:63</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Command Ring Pointer</td>
<td style="text-align: left;">指令环的地址的高 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>58</mn><annotation encoding="application/x-tex">58</annotation></semantics></math> 位，也就是将这个寄存器 <code>&amp; (~0x3ful)</code> 即为指令环的地址</td>
</tr>
</tbody>
</table>
<h3 id="devctxbaseaddr设备上下文的基地址">devCtxBaseAddr，设备上下文的基地址</h3>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Access</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:5</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Reserved</td>
<td style="text-align: left;">必须为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math></td>
</tr>
<tr class="even">
<td style="text-align: center;">6:63</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Device Context Base Address Array Pointer</td>
<td style="text-align: left;">地址的高 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>58</mn><annotation encoding="application/x-tex">58</annotation></semantics></math> 位</td>
</tr>
</tbody>
</table>
<p>实际上就是存储一个对 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>64</mn><annotation encoding="application/x-tex">64</annotation></semantics></math> 对齐的地址。</p>
<h3 id="config配置寄存器">config，配置寄存器</h3>
<table>
<colgroup>
<col style="width: 17%" />
<col style="width: 28%" />
<col style="width: 28%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Access</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:7</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Max Device Slots Enabled (MaxSlotsEn)</td>
<td style="text-align: left;">设置激活的最大插槽ID，只能在 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">RS</mtext><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\text{RS}=0</annotation></semantics></math> 的时候设置这个段。</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">U3 Entry Enable (U3E)</td>
<td style="text-align: left;">表示控制器转移到 U3 状态的时候是否设置 PLC 标志位。 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">hccParams0</mtext><annotation encoding="application/x-tex">\text{hccParams0}</annotation></semantics></math> 的 Bit 0 指示是否支持这一位。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Configuration Information Enable (CIE)</td>
<td style="text-align: left;">是否初始化 输入控制上下文块的 Configuration Value, Interface Number 和 Alternate Settings 域，<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">hccParams0</mtext><annotation encoding="application/x-tex">\text{hccParams0}</annotation></semantics></math> 的 Bit 5 指示是否支持这一位。</td>
</tr>
<tr class="even">
<td style="text-align: center;">10:31</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: center;">Reserved and preserved</td>
<td style="text-align: left;">保留</td>
</tr>
</tbody>
</table>
<h2 id="port-registers-端口状态和控制寄存器组">Port Registers, 端口状态和控制寄存器组</h2>
<p>每一个端口寄存器组由 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math> 个 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>32</mn><annotation encoding="application/x-tex">32</annotation></semantics></math> 位整数描述。某些寄存器在 USB 2.0 和 3.1 下会有不同的含义。</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Offset</th>
<th style="text-align: center;">Name</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0x0</td>
<td style="text-align: center;">stsCtrl</td>
<td style="text-align: left;">Port Status and Control, 用于端口的状态查询和控制，几乎每一个位都有作用</td>
</tr>
<tr class="even">
<td style="text-align: center;">0x4</td>
<td style="text-align: center;">pwStsCtrl</td>
<td style="text-align: left;">Port Power Management Status and Control，用于端口电源的状态查询和控制</td>
</tr>
<tr class="odd">
<td style="text-align: center;">0x8</td>
<td style="text-align: center;">lkInfo</td>
<td style="text-align: left;">Port Link Info, 保存端口的链接信息</td>
</tr>
<tr class="even">
<td style="text-align: center;">0xc</td>
<td style="text-align: center;">hwLPMCtrl</td>
<td style="text-align: left;">Port Hardware LPM Control</td>
</tr>
</tbody>
</table>
<h3 id="stsctrl-端口的状态和控制">stsCtrl, 端口的状态和控制</h3>
<p>下表展示了这个寄存器每一位的作用，对于某些位置，会有一些必要的补充说明。在 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">RS</mtext><annotation encoding="application/x-tex">\text{RS}</annotation></semantics></math> 被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 并且 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">usbHalted</mtext><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\text{usbHalted}=0</annotation></semantics></math> 之后，这个寄存器才能正常使用。</p>
<p><strong>PS</strong>: 标有下划线的位是仅适用于 USB 3.0 的位，对于 USB 2.0 协议的端口，这些位处于 Reserved and Zero’d 状态。</p>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 40%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Access</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Current Connect Status，当前连接状态，1:有设备连接；0: 无设备连接。用于设备连接检测的关键位。</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: left;">Port Enabled(1)/Disabled(0)，端口激活状态。控制器在重置后，或者端口重置后会激活端口并设置该位，由于为 WC 位，因此操作系统不能自行激活端口，只能通过重置端口或者控制器重新激活。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Reserved and Zero’d</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Over-current Active，表示该端口是否处于过流激活状态 (Over-current Active condition)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Port Reset，和 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">usbCmd</mtext><annotation encoding="application/x-tex">\text{usbCmd}</annotation></semantics></math> 的 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">HCRST</mtext><annotation encoding="application/x-tex">\text{HCRST}</annotation></semantics></math> 位功能类似。在不同协议下，重置操作略有不同。</td>
</tr>
<tr class="even">
<td style="text-align: center;">5:8</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Port Link State，链接状态，从 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟶𝟶𝟶𝟶𝚋</mtext><annotation encoding="application/x-tex">\texttt{0000b}</annotation></semantics></math> 开始分别表示 U0, U1, U2, U3 。需要设置该寄存器的 Bit 16 来启用该位的写入。一般而言，需要让链接状态处于 U0 以正常使用。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Port Power，用于开启或关闭该端口的电源。<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">hccParams1</mtext><annotation encoding="application/x-tex">\text{hccParams1}</annotation></semantics></math> 的 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Port Power</mtext><annotation encoding="application/x-tex">\text{Port Power}</annotation></semantics></math> 位指示该位是(0)否(1)可以正常使用。</td>
</tr>
<tr class="even">
<td style="text-align: center;">10:13</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Port Speed，用于指示该端口连接设备的速度和对应的协议。接下来会提供一个参照表。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">14:15</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Port Indicator Control，指标控制，表示是否可以正常操作，接下来会提供一个参照表。<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">hccParams1</mtext><annotation encoding="application/x-tex">\text{hccParams1}</annotation></semantics></math> 的 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">PIND</mtext><annotation encoding="application/x-tex">\text{PIND}</annotation></semantics></math> 指示该位是(1)否(0)可以正常使用。</td>
</tr>
<tr class="even">
<td style="text-align: center;">16</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Port Link State Write Strobe，用于指示对 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Port Link State</mtext><annotation encoding="application/x-tex">\text{Port Link State}</annotation></semantics></math> 的写入将会生效(1)/被忽略(0)。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">17</td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: left;">Connect Status Change，连接状态是否改变，用于设备连接检测的关键位。</td>
</tr>
<tr class="even">
<td style="text-align: center;">18</td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: left;">Port Enable/Disable Change，端口的激活状态是否被改变。</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><u>19</u></td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: left;">Warm Port Reset Change，当端口为 USB 2.0 协议时，这一位被保留；当端口为 USB 3.0 时，若 Warm Port Reset 完成，这一位会被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
</tr>
<tr class="even">
<td style="text-align: center;">20</td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: left;">Over-current Change，过流状态是否发生改变。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">21</td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: left;">Port Reset Change，当 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Port Reset</mtext><annotation encoding="application/x-tex">\text{Port Reset}</annotation></semantics></math> 位从 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 变为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> 的时候，这一位被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 。</td>
</tr>
<tr class="even">
<td style="text-align: center;">22</td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: left;">Port Link State Change，当 Link State 发生改变的时候，这一位被设置为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 。</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><u>23</u></td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: left;">Port Config Error Change，指示是(1)否(0)在配置链接伙伴 (link partner) 的时候发生错误。</td>
</tr>
<tr class="even">
<td style="text-align: center;"><u>24</u></td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Cold Attach Status，表示连接的设备是否因为电量不足、错误的电源状态或者其他问题导致不能正常运作。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">25</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Wake on Connect Enable，是否在连接的时候产生对应的事件。</td>
</tr>
<tr class="even">
<td style="text-align: center;">26</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Wake on Disconnect Enable，是否在断开连接的时候产生对应的事件。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">27</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Wake on Over-current Enable，是否在进入过流状态的时候产生对应的事件。</td>
</tr>
<tr class="even">
<td style="text-align: center;">28:29</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Reserved and Zero’d</td>
</tr>
<tr class="odd">
<td style="text-align: center;">30</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Device Removable，当前设备是否是可移除的设备。</td>
</tr>
<tr class="even">
<td style="text-align: center;"><u>31</u></td>
<td style="text-align: center;">R/WC</td>
<td style="text-align: left;">Warm Port Reset，操作方式和 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Port Reset</mtext><annotation encoding="application/x-tex">\text{Port Reset}</annotation></semantics></math> 类似，用 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Port Reset</mtext><annotation encoding="application/x-tex">\text{Port Reset}</annotation></semantics></math>、<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Port Reset Change</mtext><annotation encoding="application/x-tex">\text{Port Reset Change}</annotation></semantics></math> 和 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Warm Reset Change</mtext><annotation encoding="application/x-tex">\text{Warm Reset Change}</annotation></semantics></math> 来指示 Warm Reset 是否完成。</td>
</tr>
</tbody>
</table>
<p>接下来提供一个 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Port Speed</mtext><annotation encoding="application/x-tex">\text{Port Speed}</annotation></semantics></math> 的描述表：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Value</th>
<th style="text-align: center;">Speed</th>
<th style="text-align: center;">Bit Rate</th>
<th style="text-align: center;">Protocol</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">Undefined</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">full-speed</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mtext mathvariant="monospace">𝙼𝙱</mtext><mi>/</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">12 \texttt{MB}/s</annotation></semantics></math></td>
<td style="text-align: center;">USB 2.0</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">low-speed</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.5</mn><mtext mathvariant="monospace">𝙼𝙱</mtext><mi>/</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">1.5 \texttt{MB}/s</annotation></semantics></math></td>
<td style="text-align: center;">USB 2.0</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">high-speed</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>480</mn><mtext mathvariant="monospace">𝙼𝙱</mtext><mi>/</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">480 \texttt{MB}/s</annotation></semantics></math></td>
<td style="text-align: center;">USB 2.0</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">super-spped</td>
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mtext mathvariant="monospace">𝙶𝙱</mtext><mi>/</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">5 \texttt{GB}/s</annotation></semantics></math></td>
<td style="text-align: center;">USB 3.0</td>
</tr>
</tbody>
</table>
<p>还有一个 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">Port Indicator Control</mtext><annotation encoding="application/x-tex">\text{Port Indicator Control}</annotation></semantics></math> 的参考表，由于不太懂英文的含义（不能理解为啥要用颜色来定义），因此直接直译书中原文：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Value</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟶𝟶𝚋</mtext><annotation encoding="application/x-tex">\texttt{00b}</annotation></semantics></math></td>
<td style="text-align: left;">指标关闭</td>
</tr>
<tr class="even">
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟶𝟷𝚋</mtext><annotation encoding="application/x-tex">\texttt{01b}</annotation></semantics></math></td>
<td style="text-align: left;">琥珀色 (Amber)，通常表示存在错误，需要因此硬件注意。</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟷𝟶𝚋</mtext><annotation encoding="application/x-tex">\texttt{10b}</annotation></semantics></math></td>
<td style="text-align: left;">绿色 (Green)，一切正常。</td>
</tr>
<tr class="even">
<td style="text-align: center;"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟷𝟷𝚋</mtext><annotation encoding="application/x-tex">\texttt{11b}</annotation></semantics></math></td>
<td style="text-align: left;">未定义</td>
</tr>
</tbody>
</table>
<p>这里的指标指的是端口的指标，而不是端口上设备的指标。</p>
<h3 id="pwstsctrl端口电源的状态和控制">pwStsCtrl，端口电源的状态和控制</h3>
<p>对于使用 USB 2.0 的端口，使用下面的描述表：</p>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 40%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Access</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:2</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">L1 Status，表示 L1 下的暂停 (suspend) 请求的状态。接下来会提供每个值对应的含义。</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Remote Wake Enable，激活从 L1 状态的远程唤醒。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4:7</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Host Initiated Resume Duration，若该段的值为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math> ，则表示控制器初始化并退出 L1 状态后恢复所需要的时间为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>50</mn><mo>+</mo><mn>75</mn><mi>x</mi></mrow><annotation encoding="application/x-tex">50+75x</annotation></semantics></math> 。</td>
</tr>
<tr class="even">
<td style="text-align: center;">8:15</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">L1 Device Slot，用于指示该端口的哪个设备槽用于产生 LMP Token packet，<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">=0</annotation></semantics></math> 表示没有设备。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">16</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Hardware LPM Enable，<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">=1</annotation></semantics></math>: 激活硬件控制的 LPM。当 硬件 LMP 使能并不支持的时候，这个位被保留。</td>
</tr>
<tr class="even">
<td style="text-align: center;">17:27</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Reserved and preserved，保留</td>
</tr>
<tr class="odd">
<td style="text-align: center;">28:31</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">软件向这个段写入某些数字来进行特定的测试。查看技术手册 (xHCI ver 1.10 p.320) 来获取更多相关信息。</td>
</tr>
</tbody>
</table>
<p>接下来是 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">L1 Status</mtext><annotation encoding="application/x-tex">\text{L1 Status}</annotation></semantics></math> 的描述表：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Value</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: left;">Invalid，不合法，如果为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>，那么 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">L1 Status</mtext><annotation encoding="application/x-tex">\text{L1 Status}</annotation></semantics></math> 应当被忽略。</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: left;">Success，成功。端口成功转换到 L1 状态。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: left;">Not Yet，仍未转移到 L1 状态。</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: left;">Not Supported，该端口不支持转移到 L1 状态。</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: left;">Timeout or Error，超时或者发生错误。</td>
</tr>
<tr class="even">
<td style="text-align: center;">5~7</td>
<td style="text-align: left;">Reserved</td>
</tr>
</tbody>
</table>
<p>对于使用 USB 3.0 的端口，使用下面的描述符表：</p>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 40%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Access</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:7</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">U1 Timeout，表示在确定 U1 不活动并启动 U1 进入之前的延迟（以微秒为单位）。合法值为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="monospace">𝟶𝚡𝟶𝟶</mtext><mi>…</mi><mtext mathvariant="monospace">𝟶𝚡𝟽𝚏</mtext></mrow><annotation encoding="application/x-tex">\texttt{0x00}\dots\texttt{0x7f}</annotation></semantics></math> 以及 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟶𝚡𝚏𝚏</mtext><annotation encoding="application/x-tex">\texttt{0xff}</annotation></semantics></math>，若为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟶𝚡𝟶𝟶</mtext><annotation encoding="application/x-tex">\texttt{0x00}</annotation></semantics></math> 则表示不能进入 U1，否则表示微秒数。</td>
</tr>
<tr class="even">
<td style="text-align: center;">8:15</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">U2 Timeour，表示在确定 U2 不活动并启动 U2 进入之前的延迟（以微秒为单位）。合法值范围和 U1 相同。若为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="monospace">𝟶𝚡𝟶𝟶</mtext><annotation encoding="application/x-tex">\texttt{0x00}</annotation></semantics></math> 表示不能进入 U2，否则延迟的微秒数等于该段的值乘上 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>256</mn><annotation encoding="application/x-tex">256</annotation></semantics></math></td>
</tr>
<tr class="odd">
<td style="text-align: center;">16</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Force Link PM Accept，当值为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>，让端口去生成一个 Set Link Function LMP 。（不知道啥意思，这里粘出原文：tells the port to generate a Set Link Function LMP with the Force Link PM Accept Bit set.）</td>
</tr>
<tr class="even">
<td style="text-align: center;">17:31</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Reserved and preserved，保留</td>
</tr>
</tbody>
</table>
<h3 id="lkinfo链接信息">lkInfo，链接信息</h3>
<p>若端口为 USB 2.0 那么这个寄存器为 Reserved and preserved 。</p>
<p>若端口为 USB 3.0 那么使用下面的描述表：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Access</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:15</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Link Error Count，检测到的链接错误的的数量。</td>
</tr>
<tr class="even">
<td style="text-align: center;">16:19</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Rx Lane Count (RLC)，表示端口协商的接收 (Receive) 通道数减去 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
</tr>
<tr class="odd">
<td style="text-align: center;">20:23</td>
<td style="text-align: center;">RO</td>
<td style="text-align: left;">Tx Lane Count (RLC)，表示端口协商的传输 (Transmit) 通道数减去 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math></td>
</tr>
<tr class="even">
<td style="text-align: center;">24:31</td>
<td style="text-align: center;">R/W</td>
<td style="text-align: left;">Reseerved and preserved，保留</td>
</tr>
</tbody>
</table>
<h3 id="hwlpmctrl硬件的-lpm-控制寄存器">hwLPMCtrl，硬件的 LPM 控制寄存器</h3>
<p>若端口为 USB 2.0 那么使用下面的描述表：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Access</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0:1</td>
<td style="text-align: center;">RWS</td>
<td style="text-align: left;">Host Initiated Resume Duration Mode (HIRDM)，必须为 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math> 或 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math> 。</td>
</tr>
<tr class="even">
<td style="text-align: center;">2:9</td>
<td style="text-align: center;">RWS</td>
<td style="text-align: left;">L1 Timeout，表示超时时间除以 <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>128</mn><annotation encoding="application/x-tex">128</annotation></semantics></math></td>
</tr>
<tr class="odd">
<td style="text-align: center;">10:13</td>
<td style="text-align: center;">RWS</td>
<td style="text-align: left;">Best Effort Service Latency Deep (BESLD)，表示接收设备在 U2 退出后要等待多长时间。</td>
</tr>
<tr class="even">
<td style="text-align: center;">14:31</td>
<td style="text-align: center;">RWS</td>
<td style="text-align: left;">Reserved and preserved，保留</td>
</tr>
</tbody>
</table>
<p>若端口为 USB 3.0 那么这个寄存器为 Reserved and preserved 。</p>
</body>
</html>
