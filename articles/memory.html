<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>memory</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      border: none;
      border-top: 1px solid #1a1a1a;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="segment-registers">Segment Registers</h1>
<ul>
<li><code>ds</code>: Data Segment</li>
<li><code>es</code>: Extend Segment</li>
<li><code>cs</code>: Code Segment</li>
<li><code>ss</code>: Stack Segment</li>
<li><code>fs</code> and <code>gs</code>: General-purpose Segment</li>
</ul>
<p>In long-mode, <code>ds, es, ss, cs</code> are treated as their
<strong>base</strong> was
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>
no matter what the descriptor is. The limit check is disabled.</p>
<h1 id="paging-and-page-table">Paging and Page Table</h1>
<p>In long-mode, the size of one address is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>64</mn><annotation encoding="application/x-tex">64</annotation></semantics></math>
bits, but the highest 8 bits are just the copy of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>47</mn><annotation encoding="application/x-tex">47</annotation></semantics></math>
bit (counting from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>).
Therefore the effective number of digits in a memory address is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>48</mn><annotation encoding="application/x-tex">48</annotation></semantics></math>.</p>
<p>While the segment memory management is nearly disabled, paging system
is used to convert virtual address to physics address, allowing the
isolation of processes and giving convenience for implementation of non
contiguous memory occupation of one process. Paging divides an virtual
address into
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>5</mn><annotation encoding="application/x-tex">5</annotation></semantics></math>
parts from higher bits to lower bits. The first
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math>
parts are all 9-bit long, and is used as the index of one level of page
table. And the last part is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>12</mn><annotation encoding="application/x-tex">12</annotation></semantics></math>-bit
long and used as the offset inside page.</p>
<p>In my project,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math>
levels of page table are named from highest level to lowest level as
Page Global Directory (PGD), Page Upper Directory (PUD), Page Middle
Directory (PMD), Page Lower Directory (PLD).</p>
<p>For one page table, base physics address should be aligned to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mtext mathvariant="monospace">𝙺𝙱</mtext></mrow><annotation encoding="application/x-tex">4\texttt{KB}</annotation></semantics></math>.
There are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>512</mn><annotation encoding="application/x-tex">512</annotation></semantics></math>
items, which called “entries”, in one pages, each item is a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>64</mn><annotation encoding="application/x-tex">64</annotation></semantics></math>-bit
integer. Thus, the size of one page table is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>512</mn><mo>×</mo><mn>8</mn><mtext mathvariant="monospace">𝙱</mtext><mo>=</mo><mn>4</mn><mtext mathvariant="monospace">𝙺𝙱</mtext></mrow><annotation encoding="application/x-tex">512 \times 8\texttt{B} = 4\texttt{KB}</annotation></semantics></math>
.</p>
<p>The structure of items in each level is different. For items of PGD,
PUD and PMD, one item contains the pointer (a physics address) to the
next level page table, along with some attributes of the memory that
managed by this item. While PLD contains the base physics address
managed by this page and some attributes. The details of these
structures will be shown below.</p>
<p>The address of PGD is stored in register <code>CR3</code>, and
<code>movq</code> can be used to modify and access it. Because of the
effect of TLB (a cache for speeding up the convertion), the adjustment
of page table may not make effects immediately, but
<code>movq xxx, %cr3</code> can compulsorily flush the TLB.</p>
<p>In some scenarios, PLD would disappear (when the <strong>PS</strong>
bit of PMD is set to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>,
which will be introduced later) and the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mi>.</mi><mi>.</mi><mn>.21</mn></mrow><annotation encoding="application/x-tex">0...21</annotation></semantics></math>-th
bits will be directly used as the offset inside page, which means that
we use
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mtext mathvariant="monospace">𝙼𝙱</mtext></mrow><annotation encoding="application/x-tex">2\texttt{MB}</annotation></semantics></math>
pages instead of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mtext mathvariant="monospace">𝙺𝙱</mtext></mrow><annotation encoding="application/x-tex">4\texttt{KB}</annotation></semantics></math>
pages. In other scenarios, both PLD and PMD would disapper and the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mi>.</mi><mi>.</mi><mn>.30</mn></mrow><annotation encoding="application/x-tex">0...30</annotation></semantics></math>-th
bits will be directly used as the offset inside page</p>
<p>In the initialization period, due to the limitation of space usage, I
disable the PLD and use
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mtext mathvariant="monospace">𝙼𝙱</mtext></mrow><annotation encoding="application/x-tex">2\texttt{MB}</annotation></semantics></math>
pages instead.</p>
<h2 id="description-of-items">Description of Items</h2>
<p>Let me first introduce the names and meaning of the attribute
bits.</p>
<ul>
<li><strong>P</strong>, Present. it should be
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>.</li>
<li><strong>R/W</strong>, Read/Write.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>:
Allows to write this memory
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>:
Not allowed to write. and this page is read-only</li>
<li><strong>U/S</strong>, User/Supervisor.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>:
This page can be accessed by all privilege level.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>:
user is not allowed to use this page.</li>
<li><strong>PWT</strong>, Page-level Write-Through.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>:
Write-though caching is enabled.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>:
Write-back is enabled.</li>
<li><strong>PCD</strong>, Cache Disable.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>:
This page will not be cached.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>:
will be cached.</li>
<li><strong>A</strong>, Accessed. This bit is to shown whether a this
item was used during converting, which will be adjust by MMU (the
convertion tool of CPU) automatically.</li>
<li><strong>D</strong>, Dirty. This bit is used to shown whether a page
has been written to.</li>
<li><strong>PS</strong>, Page Size.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>:
This item directly maps to a page.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>:
This item leads to a page table of the next level.</li>
<li><strong>G</strong>, Global. This bit tells the processor not to
invalidate the TLB entry corresponding to the page upon a instruction
<code>mov</code> to <code>CR3</code> instruction. And the
<strong>PGE</strong> bit of <code>CR4</code> (the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>7</mn><annotation encoding="application/x-tex">7</annotation></semantics></math>-th
bit) should be set. In this project, this bit should be
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>.</li>
</ul>
<p>PS: I ignore some useless attribute bit.</p>
<h3 id="pgd">PGD</h3>
<p>A PGD can manage the whole virtual address space, while one entry of
PGD can manage
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>512</mn><mtext mathvariant="monospace">𝙶𝙱</mtext></mrow><annotation encoding="application/x-tex">512\texttt{GB}</annotation></semantics></math>
.</p>
<ul>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>:
<strong>P</strong></li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>:
<strong>R/W</strong></li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math>:
<strong>U/S</strong></li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>3</mn><annotation encoding="application/x-tex">3</annotation></semantics></math>:
<strong>PWT</strong></li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math>:
<strong>PCD</strong></li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>5</mn><annotation encoding="application/x-tex">5</annotation></semantics></math>:
<strong>A</strong></li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>6</mn><annotation encoding="application/x-tex">6</annotation></semantics></math>:
Ignored.</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>7</mn><annotation encoding="application/x-tex">7</annotation></semantics></math>:
<strong>PS</strong>, Reserved and must be
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>.</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mi>.</mi><mi>.</mi><mn>.10</mn></mrow><annotation encoding="application/x-tex">8...10</annotation></semantics></math>:
Ignored.</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>11</mn><annotation encoding="application/x-tex">11</annotation></semantics></math>:
<strong>R</strong>, something not so important and can will be set to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>
.</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mi>.</mi><mi>.</mi><mn>.47</mn></mrow><annotation encoding="application/x-tex">12...47</annotation></semantics></math>:
The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mi>.</mi><mi>.</mi><mn>.47</mn></mrow><annotation encoding="application/x-tex">12...47</annotation></semantics></math>-th
of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mtext mathvariant="monospace">𝙺𝙱</mtext></mrow><annotation encoding="application/x-tex">4\texttt{KB}</annotation></semantics></math>-aligned
address of the PUD referenced by this item.</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>48</mn><mi>.</mi><mi>.</mi><mn>.62</mn></mrow><annotation encoding="application/x-tex">48...62</annotation></semantics></math>:
From
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>48</mn><mi>.</mi><mi>.</mi><mn>.51</mn></mrow><annotation encoding="application/x-tex">48...51</annotation></semantics></math>-th
bits, which are reserved, the values should be
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>.
And the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>52</mn><mi>.</mi><mi>.</mi><mn>.62</mn></mrow><annotation encoding="application/x-tex">52...62</annotation></semantics></math>-th
bits are ignored.</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>63</mn><annotation encoding="application/x-tex">63</annotation></semantics></math>:
In this project, this bit should be
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>.</li>
</ul>
<h3 id="pud">PUD</h3>
<ul>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mi>.</mi><mi>.</mi><mn>.5</mn></mrow><annotation encoding="application/x-tex">0...5</annotation></semantics></math>:
These bits are the same as those of PGD</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>6</mn><annotation encoding="application/x-tex">6</annotation></semantics></math>:
<strong>D</strong></li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>7</mn><annotation encoding="application/x-tex">7</annotation></semantics></math>:
<strong>PS</strong>.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>:
this entry directly maps to a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mtext mathvariant="monospace">𝙶𝙱</mtext></mrow><annotation encoding="application/x-tex">1\texttt{GB}</annotation></semantics></math>
page and then
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>12</mn><annotation encoding="application/x-tex">12</annotation></semantics></math>-th
bit of this entry is <strong>PAT</strong> bit.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>:
this entry refers to a PMD. During this project, this bit is always
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>.</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>8</mn><annotation encoding="application/x-tex">8</annotation></semantics></math>:
<strong>G</strong>. If <strong>PS</strong> is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>,
then this bit will be ignore. But as what I said before, throughout this
project, this bit will be always
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>.</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>9</mn><mi>.</mi><mi>.</mi><mn>.10</mn></mrow><annotation encoding="application/x-tex">9...10</annotation></semantics></math>:
Ignored.</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>11</mn><annotation encoding="application/x-tex">11</annotation></semantics></math>:
<strong>R</strong>.</li>
<li>if
<strong>PS</strong>=<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>:
<ul>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>12</mn><annotation encoding="application/x-tex">12</annotation></semantics></math>:
<strong>PAT</strong></li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>13</mn><mi>.</mi><mi>.</mi><mn>.29</mn></mrow><annotation encoding="application/x-tex">13...29</annotation></semantics></math>:
Reserved and should be
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>.</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>30</mn><mi>.</mi><mi>.</mi><mn>.47</mn></mrow><annotation encoding="application/x-tex">30...47</annotation></semantics></math>:
The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>30</mn><mi>.</mi><mi>.</mi><mn>.47</mn></mrow><annotation encoding="application/x-tex">30...47</annotation></semantics></math>-th
bits of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mtext mathvariant="monospace">𝙶𝙱</mtext></mrow><annotation encoding="application/x-tex">1\texttt{GB}</annotation></semantics></math>-aligned
physics page referenced by this entry.</li>
</ul></li>
<li>if
<strong>PS</strong>=<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>:
<ul>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mi>.</mi><mi>.</mi><mn>.47</mn></mrow><annotation encoding="application/x-tex">12...47</annotation></semantics></math>:
The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mi>.</mi><mi>.</mi><mn>.47</mn></mrow><annotation encoding="application/x-tex">12...47</annotation></semantics></math>-th
of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mtext mathvariant="monospace">𝙺𝙱</mtext></mrow><annotation encoding="application/x-tex">4\texttt{KB}</annotation></semantics></math>-aligned
address of the PMD referenced by this item.</li>
</ul></li>
<li>The rest bits are the same as those of PGD.</li>
</ul>
<h3 id="pmd">PMD</h3>
<p>The description of PMD is similar to PUD, so I will not show it
again. The only difference is that when <strong>PS</strong>=1, the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>21</mn><mi>.</mi><mi>.</mi><mn>.48</mn></mrow><annotation encoding="application/x-tex">21...48</annotation></semantics></math>-th
bits reference to the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mtext mathvariant="monospace">𝙼𝙱</mtext></mrow><annotation encoding="application/x-tex">2\texttt{MB}</annotation></semantics></math>-aligned
physics page.</p>
<h3 id="pld">PLD</h3>
<ul>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mi>.</mi><mi>.</mi><mn>.11</mn></mrow><annotation encoding="application/x-tex">0...11</annotation></semantics></math>:
These bits are the same as those in PGD. But the <strong>PS</strong> bit
should be zero.</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mi>.</mi><mi>.</mi><mn>.47</mn></mrow><annotation encoding="application/x-tex">12...47</annotation></semantics></math>:
The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mi>.</mi><mi>.</mi><mn>.47</mn></mrow><annotation encoding="application/x-tex">12...47</annotation></semantics></math>-th
of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mtext mathvariant="monospace">𝙺𝙱</mtext></mrow><annotation encoding="application/x-tex">4\texttt{KB}</annotation></semantics></math>-aligned
physics page referenced by this entry.</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>47</mn><mi>.</mi><mi>.</mi><mn>.63</mn></mrow><annotation encoding="application/x-tex">47...63</annotation></semantics></math>:
These bits are the same as those in PGD.</li>
</ul>
<h1 id="memory-management">Memory Management</h1>
<h2 id="initialization-process">Initialization Process</h2>
<p>During the initialization period, the kernel program will first use
the mapped address space in <code>head.S</code>, whose size is below
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>512</mn><mtext mathvariant="monospace">𝙼𝙱</mtext></mrow><annotation encoding="application/x-tex">512\texttt{MB}</annotation></semantics></math>
to build the page table of ‘directly mapping address space’ (DMAS), and
along with the page array, the zone array and the bitmap. The addresses
of the elements of these three arrays are contiguous respectively and
within the range of DMAS, so the program will first set the zone arrays,
then find the valid address space to set the page array and bitmap
respectively.</p>
<p>DMAS is an area whose virtual address is just the physics address
added up with an offse. The maximum virtual address space is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">[</mo><mtext mathvariant="monospace">𝟶𝚡𝚏𝚏𝚏𝚏𝟾𝟾𝟶𝟶𝟶𝟶𝟶𝟶𝟶𝟶𝟶𝟶</mtext><mo>,</mo><mtext mathvariant="monospace">𝟶𝚡𝚏𝚏𝚏𝚏𝙲𝟾𝟶𝟶𝟶𝟶𝟶𝟶𝟶𝟶𝟶𝟶</mtext><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[\texttt{0xffff880000000000}, \texttt{0xffffC80000000000}]</annotation></semantics></math>,
and maximum size is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>64</mn><mtext mathvariant="monospace">𝚃𝙱</mtext></mrow><annotation encoding="application/x-tex">64\texttt{TB}</annotation></semantics></math>.
The following equation is the the relationship of the physics address
and the virtual address of this space:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">physics address</mtext><mo>=</mo><mtext mathvariant="normal">virtual address</mtext><mo>−</mo><mtext mathvariant="monospace">𝟶𝚡𝚏𝚏𝚏𝚏𝟾𝟾𝟶𝟶𝟶𝟶𝟶𝟶𝟶𝟶𝟶𝟶</mtext></mrow><annotation encoding="application/x-tex">
\text{physics address}=\text{virtual address} - \texttt{0xffff880000000000}
</annotation></semantics></math></p>
<p>After initialization of DMAS and those arrays, the Buddy System is
built, also using virtual address in DMAS. Then the cache for page table
management is built up, by allocating the memory from the Buddy System.
Then the SLAB System is built, also by applying the APIs of Buddy
System.</p>
<h2 id="apis-and-algorithms-behind-them">APIs and Algorithms behind
Them</h2>
<h3 id="basic-memory-management">Basic Memory Management</h3>
<p>for every
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mtext mathvariant="monospace">𝙺𝙱</mtext></mrow><annotation encoding="application/x-tex">4\texttt{KB}</annotation></semantics></math>
page, there is a structure to manage its attributes, physics address and
numbers of reference. A zone struct manage the pages that belongs to it
and the general attribute of these pages, like the reference number,
free page number and active page number. each bit of the bitmap stores
whether this page is allocated or not. This basic management structure
is temporary used to manage the memory that used to build the Buddy
System and page table of DMAS.</p>
<p><strong>PS</strong> - This management system can only manage the
pages in the range of DMAS. - No API for releasing pages. - Once the
buddy system is built up, it is invalid to use this system, excepts the
<code>BsMemManage_setPageAttr(Page *, u64 attr)</code> and
<code>BsMemMange_getPageAttr(Page *)</code>.</p>
<p><strong>APIs</strong>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// initialize this system</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> BsMemManage_init<span class="op">()</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">// allocate NUM pages and set the attributes of them to ATTR</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>Page <span class="op">*</span>BsMemManage_alloc<span class="op">(</span><span class="dt">int</span> num<span class="op">,</span> <span class="dt">int</span> attr<span class="op">)</span> </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">// get the attribute of PAGE</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>u64 BsMemManage_getPageAttr<span class="op">(</span>Page <span class="op">*</span>page<span class="op">);</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">// set the attribute of PAGE to ATTR</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> BsMemManage_setPageAttr<span class="op">(</span>Page <span class="op">*</span>page<span class="op">,</span> u64 attr<span class="op">);</span></span></code></pre></div>
<h3 id="buddy-system">Buddy System</h3>
<p>This system divides the pages into groups, whose size a power of 2.
These group is called page frame. Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>f</mi></msub><mo>=</mo><msub><mi>log</mi><mo>&#8289;</mo><mn>2</mn></msub><mo stretchy="false" form="prefix">(</mo><mrow><mtext mathvariant="normal">the number of pages in the page frame </mtext><mspace width="0.333em"></mspace></mrow><mi>f</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">S_f=\log_2(\text{the number of pages in the page frame }f)</annotation></semantics></math>.
We say that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>f</mi><annotation encoding="application/x-tex">f</annotation></semantics></math>
is in the <strong>frame group</strong>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
if and only if
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>f</mi></msub><mo>=</mo><mi>i</mi></mrow><annotation encoding="application/x-tex">S_f=i</annotation></semantics></math>
. Due to the limitation of kernel memory used,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mi>f</mi></msub><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mn>11</mn><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">S_f\in [0, 11]</annotation></semantics></math>.
In one page frame, the first page is called <strong>head page</strong>.
Kernel and Users can allocate and free a <strong>whole</strong> page
frame. All the pages in one allocated page frame has the same attribute,
which is stored in the head page of this page frame. Furthermore, the
head page has an attribute call <code>Page_Flag_HeadPage</code> , while
the others don’t.</p>
<p>Two basic operations of this system is “division” and “merger”.
Division is to split a page frame into two buddy page frames, who sizes
are the same, while the “merger” it to merge two buddy page frames into
a larger page frame. It is be noticed that two buddy page frames are
called buddies is not because of the same size of them, and the true
reason is that their are “born” from the same page frame.</p>
<p>When initializing this system, the page frame will be merged to
ensure that the number is page frames is minimum. When it is asked to
allocate a page frame, while there is no page frames that meet its
requirement of size, the system will divide a page frame which is larger
than the requirement recursively, and get the prefix of it to allocate.
When a page frame is going to be released, the system will try to merge
recursively when its buddy is also free.</p>
<p>The algorithm for finding the buddy of one page is using the
numbering method which is similar to that of segment tree. Another
important part is use a bitmap to manage whether the states of
allocation (allocated/free) of one pages and their buddies are the same.
One page and its buddy share the same bit. When one page is allocated or
released, that bit will be reversed.</p>
<p><strong>APIs</strong>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Buddy_init<span class="op">();</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>Page <span class="op">*</span>Buddy_alloc<span class="op">(</span><span class="dt">int</span> log2Size<span class="op">,</span> u64 attr<span class="op">);</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Buddy_free<span class="op">(</span>Page <span class="op">*);</span></span></code></pre></div>
<h3 id="page-table">Page Table</h3>
<p>This system manages the PGD, PUP, PMD, PLD entries and includes the
allocation and releasing of page table. Like Slab system, a cache pool
is used. When the size of this cache pool meets the minimum, a page
frame will be allocated using Buddy System and the size of cache pool
will reach its maximum. When a page table is released and the size of
the cache pool exceeds the maximum, then the page that contains this
page table will be directly released to Buddy System.</p>
<p><strong>APIs</strong>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> PageTable_init<span class="op">();</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> PageTable_map<span class="op">(</span>u64 vAddr<span class="op">,</span> u64 pAddr<span class="op">);</span> <span class="co">// map a memory block [pAddr, pAddr + Page_4KSize - 1] to [vAddr, vAddr + page_4KSize - 1]</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> PageTable_unmap<span class="op">(</span>u64 vAddr<span class="op">);</span></span></code></pre></div>
<h3 id="slab">SLAB</h3>
<p>This system contains a series of cache pool differentiated by size.
from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>5</mn></msup><mtext mathvariant="monospace">𝙱</mtext><mo>,</mo><msup><mn>2</mn><mn>6</mn></msup><mtext mathvariant="monospace">𝙱</mtext><mi>.</mi><mi>.</mi><mi>.</mi><mn>1</mn><mtext mathvariant="monospace">𝙼𝙱</mtext></mrow><annotation encoding="application/x-tex">2^5 \texttt{B}, 2^6 \texttt{B}... 1\texttt{MB}</annotation></semantics></math>
. There will be numbers of memory blocks in each cache pool, which sizes
are all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mtext mathvariant="monospace">𝙼𝙱</mtext></mrow><annotation encoding="application/x-tex">2\texttt{MB}</annotation></semantics></math>
, Thus one memory block can allocate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mfrac><mrow><mn>2</mn><mtext mathvariant="monospace">𝙼𝙱</mtext></mrow><mtext mathvariant="normal">Size of the pool that this block belongs to</mtext></mfrac><annotation encoding="application/x-tex">\frac{2\texttt{MB}}{\text{Size of the pool that this block belongs to}}</annotation></semantics></math>,
Additionally, when a memory block is completely free, and the numbers of
free objects the pool that this block belongs to is higher than
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>3</mn><mn>2</mn></mfrac><mo>×</mo><mo stretchy="false" form="prefix">(</mo><mtext mathvariant="normal">numbers of free objects of this block</mtext><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\frac{3}{2}\times (\text{numbers of free objects of this block})</annotation></semantics></math>,
then this block will be released. When a pool runs out of free objects,
then a new memory block will be allocated from Buddy System.</p>
<p>Additionally, since this system only used in kernel program, the
virtual address of allocated memory block is always in DMAS range.</p>
<p><strong>APIs</strong>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> SLAB_init<span class="op">();</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>kmalloc<span class="op">(</span>u64 size<span class="op">,</span> u64 arg<span class="op">);</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> free<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>addr<span class="op">);</span></span></code></pre></div>
</body>
</html>
